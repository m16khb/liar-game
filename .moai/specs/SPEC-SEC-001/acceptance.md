# SPEC-SEC-001 인수 기준

## 개요

게임 보안 강화 시스템의 인수 테스트 시나리오 (Given-When-Then 형식)

## 1. 비밀번호 해싱

### 1.1 비밀번호 저장
**Given** 사용자가 회원가입 시 'password123!'를 입력할 때
**When** 회원가입을 완료하면
**Then** 데이터베이스에 평문이 아닌 bcrypt 해시 값으로 저장되고 원래 비밀번호는 복원할 수 없다

### 1.2 비밀번호 검증
**Given** 사용자가 로그인 시 올바른 비밀번호를 입력할 때
**When** 인증을 시도하면
**Then** bcrypt 검증을 통해 성공적으로 로그인된다

### 1.3 비밀번호 강도 검증
**Given** 사용자가 '1234'와 같은 약한 비밀번호를 입력할 때
**When** 회원가입을 시도하면
**Then** "비밀번호는 8자 이상이며 숫자, 특수문자를 포함해야 합니다" 메시지가 표시된다

## 2. Rate Limiting

### 2.1 로그인 시도 제한
**Given** 사용자가 1분 내에 5회 로그인에 실패했을 때
**When** 6번째 로그인을 시도하면
**Then** "너무 많은 로그인 시도가 있었습니다. 15분 후 다시 시도해주세요" 메시지가 표시된다

### 2.2 API 호출 제한
**Given** 일반 사용자가 1분에 100회의 API를 호출할 때
**When** 101번째 API를 호출하면
**Then** HTTP 429 Too Many Requests 상태 코드가 반환된다

### 2.3 IP 기반 제한
**Given** 동일한 IP에서 100개의 계정 생성 요청이 있을 때
**When** 101번째 계정 생성을 요청하면
**Then** 요청이 차단되고 IP가 일시적으로 블록된다

## 3. XSS 방어

### 3.1 스크립트 주입 방지
**Given** 사용자가 닉네임에 `<script>alert('XSS')</script>`를 입력할 때
**When** 프로필을 저장하면
**Then** 스크립트가 실행되지 않고 텍스트로만 표시된다

### 3.2 HTML sanitization
**Given** 사용자가 게시글에 악성 HTML 코드를 삽입할 때
**When** 게시글을 저장하면
**Then** 위험한 태그와 속성이 제거된 안전한 HTML만 저장된다

### 3.3 CSP 헤더 적용
**Given** 웹사이트에 접속할 때
**When** 브라우저 개발자 도구를 확인하면
**Then** Content-Security-Policy 헤더가 설정되어 인라인 스크립트 실행이 차단된다

## 4. CSRF 방어

### 4.1 CSRF 토큰 검증
**Given** 사용자가 로그인되어 있을 때
**When** 외부 사이트에서 게시글 작성 폼을 제출하면
**Then** CSRF 토큰이 없어 요청이 거부된다

### 4.2 상태 변경 요청 보호
**Given** 사용자가 DELETE 요청으로 게시글을 삭제하려 할 때
**When** 유효한 CSRF 토큰 없이 요청하면
**Then** 403 Forbidden 응답이 반환된다

### 4.3 토큰 생성 및 검증
**Given** 사용자가 페이지에 접속할 때
**When** 페이지가 로드되면
**Then** 고유한 CSRF 토큰이 생성되고 숨겨진 필드에 삽입된다

## 5. JWT 토큰 관리

### 5.1 토큰 만료 검증
**Given** 사용자가 15분 전에 발급받은 Access Token을 사용할 때
**When** API를 호출하면
**Then** 401 Unauthorized 응답과 함께 토큰이 만료되었다는 메시지가 반환된다

### 5.2 Refresh Token 사용
**Given** Access Token이 만료되었고 유효한 Refresh Token이 있을 때
**When** 토큰 갱신 요청을 보내면
**Then** 새로운 Access Token이 발급된다

### 5.3 토큰 블랙리스트
**Given** 사용자가 로그아웃할 때
**When** 로그아웃 요청을 처리하면
**Then** 해당 토큰이 블랙리스트에 추가되어 더 이상 사용할 수 없다

## 6. 접근 제어

### 6.1 Role 기반 접근
**Given** 일반 사용자가 관리자 전용 API를 호출할 때
**When** 요청을 보내면
**Then** 403 Forbidden 응답이 반환되고 "권한이 없습니다" 메시지가 표시된다

### 6.2 리소스 소유권 확인
**Given** 사용자 A가 사용자 B의 프로필을 수정하려 할 때
**When** 수정 요청을 보내면
**Then** 자신의 리소스만 수정할 수 있다는 메시지와 함께 요청이 거부된다

### 6.3 최소 권한 원칙
**Given** 새로운 역할이 생성될 때
**When** 기본 권한을 할당하면
**Then** 필요한 최소한의 권한만 부여된다

## 7. 보안 로깅

### 7.1 로그인 실패 기록
**Given** 사용자가 잘못된 비밀번호로 로그인을 시도할 때
**When** 인증이 실패하면
**Then** 로그에 사용자 ID, IP, 시간, 실패 사유가 기록된다

### 7.2 권한 변경 감사
**Given** 관리자가 사용자의 권한을 변경할 때
**When** 변경이 완료되면
**Then** 누가, 언제, 무엇을 변경했는지 감사 로그에 기록된다

### 7.3 이상 활동 탐지
**Given** 사용자가 평소와 다른 국가에서 로그인할 때
**When** 로그인이 성공하면
**Then** 관리자에게 이상 로그인 알림이 전송된다

## 8. 데이터 암호화

### 8.1 전송 중 암호화
**Given** 클라이언트와 서버 간 통신할 때
**When** 네트워크 패킷을 캡처하면
**Then** 모든 데이터가 TLS 1.3으로 암호화되어 있다

### 8.2 민감 데이터 저장
**Given** 사용자의 주민등록번호를 저장할 때
**When** 데이터베이스를 확인하면
**Then** 평문이 아닌 암호화된 형태로 저장된다

### 8.3 키 로테이션
**Given** 90일이 경과했을 때
**When** 키 로테이션 작업이 실행되면
**Then** 새로운 암호화 키가 생성되고 기존 데이터가 재암호화된다

## 9. 2단계 인증 (2FA)

### 9.1 TOTP 설정
**Given** 사용자가 2FA를 활성화할 때
**When** QR 코드를 스캔하고 OTP를 입력하면
**Then** 2FA가 성공적으로 설정된다

### 9.2 로그인 시 2FA 검증
**Given** 2FA가 설정된 계정으로 로그인할 때
**When** 비밀번호 인증 후 OTP를 입력하면
**Then** OTP가 유효한 경우에만 로그인이 완료된다

### 9.3 복구 코드
**Given** 사용자가 OTP를 사용할 수 없을 때
**When** 복구 코드 중 하나를 입력하면
**Then** 2FA를 우회하여 로그인할 수 있다

## 10. API 보안

### 10.1 API 키 인증
**Given** API 키 없이 보호된 엔드포인트에 접근할 때
**When** 요청을 보내면
**Then** 401 Unauthorized 응답이 반환된다

### 10.2 요청 검증
**Given** 잘못된 형식의 JSON 데이터를 전송할 때
**When** API를 호출하면
**Then** 400 Bad Request와 함께 상세한 에러 메시지가 반환된다

### 10.3 API 사용량 제한
**Given** 무료 플랜 사용자가 월 1000회 쿼터를 모두 사용했을 때
**When** 추가 API를 호출하면
**Then** "사용량 한도를 초과했습니다" 메시지와 함께 429 응답이 반환된다

## 11. 예외 상황 처리

### 11.1 서비스 거부 공격
**Given** 대량의 동시 요청이 서버에 도착할 때
**When** 서버가 처리를 시작하면
**Then** Rate Limiting이 활성화되어 정상적인 서비스가 유지된다

### 11.2 데이터베이스 접근 시도
**Given** 공격자가 SQL Injection을 시도할 때
**When** 악성 쿼리를 전송하면
**Then** 쿼리가 파라미터화되어 공격이 차단된다

### 11.3 세션 하이재킹
**Given** 공격자가 다른 사용자의 세션 쿠키를 탈취할 때
**When** 해당 쿠키로 요청을 보내면
**Then** IP와 User-Agent를 검증하여 세션을 무효화한다

## 품질 게이트 기준

- 모든 보안 테스트 통과율: 100%
- OWASP Top 10 취약점: 0개
- 침투 테스트 결과: 심각/고위험 취약점 0개
- TLS 구성 등급: A+ (SSL Labs)
- 보안 헤더 점수: A (Security Headers)
- 평균 인증 응답 시간: 500ms 이하
- Rate Limiting 정확도: 99.9% 이상
- 로그 무결성: 100% (위변조 방지)