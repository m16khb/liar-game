# SPEC-UI-001 Acceptance Criteria

## 개요

본 문서는 **SPEC-UI-001: 사용자 로그인 플로우 및 인증 가드**의 상세 인수 기준(Acceptance Criteria)을 정의합니다.

모든 인수 기준은 **Given-When-Then** 형식으로 작성되며, 수동 또는 자동화된 테스트로 검증 가능해야 합니다.

---

## AC-001: 미인증 사용자 메인 페이지 진입

**Given**: 사용자가 로그인하지 않은 상태 (세션 없음)
**When**: 메인 페이지(`/`)에 접속
**Then**:
- 로그인 버튼과 게스트 플레이 버튼이 표시됨
- 로딩 스피너는 500ms 이내에 사라짐
- "라이어 게임" 타이틀과 "로그인하기" CTA가 명확히 보임
- 게임 페이지로 자동 리다이렉트되지 않음

**검증 방법**:
- 시크릿 모드 브라우저에서 수동 확인
- E2E 테스트: Playwright로 버튼 존재 여부 확인
- 스크린샷 비교 테스트

**우선순위**: Critical

---

## AC-002: 인증된 사용자 메인 페이지 자동 리다이렉트

**Given**: 사용자가 이미 로그인된 상태 (유효한 세션 보유)
**When**: 메인 페이지(`/`)에 접속
**Then**:
- 자동으로 `/game` 페이지로 리다이렉트됨
- 불필요한 로그인 화면을 보지 않음
- 리다이렉트는 1초 이내에 완료됨
- 브라우저 히스토리에 `/` 기록이 남지 않음 (307 리다이렉트)

**검증 방법**:
- 로그인 후 메인 페이지 접속 시도
- E2E 테스트: `page.url()`로 최종 URL 확인
- Network 탭에서 리다이렉트 상태 코드 확인

**우선순위**: Critical

---

## AC-003: 미인증 사용자 게임 페이지 접근 차단

**Given**: 사용자가 로그인하지 않은 상태
**When**: 브라우저 주소창에 `/game` URL을 직접 입력하여 접속
**Then**:
- 즉시 `/login` 페이지로 리다이렉트됨
- Middleware 레벨에서 차단됨 (서버 사이드)
- 게임 페이지 콘텐츠가 렌더링되지 않음
- 리다이렉트 후 로그인 페이지에 "로그인이 필요합니다" 안내 표시 (선택사항)

**검증 방법**:
- 시크릿 모드에서 `/game` 직접 접속
- Middleware 테스트: `middleware.test.ts`
- E2E 테스트: 최종 URL이 `/login`인지 확인

**우선순위**: Critical

---

## AC-004: 인증된 사용자 게임 페이지 접근 허용

**Given**: 사용자가 로그인된 상태
**When**: `/game` 페이지에 접속
**Then**:
- 게임 대기실 화면이 표시됨
- 사용자 이메일이 "환영합니다, {email}님!" 형식으로 표시됨
- "게임 시작하기" 버튼이 활성화됨
- 리다이렉트되지 않고 페이지가 정상 렌더링됨

**검증 방법**:
- 로그인 후 게임 페이지 접속
- E2E 테스트: 사용자 이메일 텍스트 확인
- 스크린샷 회귀 테스트

**우선순위**: Critical

---

## AC-005: 인증된 사용자 로그인 페이지 역리다이렉트

**Given**: 사용자가 이미 로그인된 상태
**When**: 브라우저 주소창에 `/login` URL을 입력하여 접속
**Then**:
- 자동으로 `/game` 페이지로 리다이렉트됨
- 로그인 폼이 렌더링되지 않음
- Middleware 레벨에서 처리됨
- 무한 리다이렉트 루프가 발생하지 않음

**검증 방법**:
- 로그인 후 `/login` 직접 접속
- Middleware 테스트: `middleware.test.ts`
- E2E 테스트: 최종 URL이 `/game`인지 확인

**우선순위**: High

---

## AC-006: 익명 사용자 게임 페이지 접근

**Given**: 사용자가 익명 로그인(Anonymous Auth)을 수행한 상태
**When**: `/game` 페이지에 접속
**Then**:
- 게임 대기실이 표시됨
- 사용자 이름이 "게스트"로 표시됨
- 게임 기능은 제한적으로 제공됨 (향후 GAME-001에서 구현)
- 이메일 대신 "게스트님" 안내 문구 표시

**검증 방법**:
- 익명 로그인 후 게임 페이지 접속
- 단위 테스트: `is_anonymous` 플래그 확인
- E2E 테스트: "게스트님" 텍스트 존재 확인

**우선순위**: Medium

---

## AC-007: 세션 만료 시 자동 로그아웃 처리

**Given**: 사용자가 로그인된 상태에서 세션이 만료됨
**When**: 보호된 경로(`/game`)에 접근 시도
**Then**:
- Middleware가 만료된 세션을 감지함
- 자동으로 `/login` 페이지로 리다이렉트됨
- 세션 쿠키가 삭제됨
- "세션이 만료되었습니다" 안내 메시지 표시 (선택사항)

**검증 방법**:
- 수동: 세션 쿠키를 수정하여 만료 시뮬레이션
- 단위 테스트: `supabase.auth.getSession()` 에러 처리
- E2E 테스트: 만료된 세션으로 게임 페이지 접근

**우선순위**: High

---

## AC-008: Middleware 무한 리다이렉트 방지

**Given**: Middleware가 실행 중
**When**: 리다이렉트 조건이 중복되거나 순환 참조 발생
**Then**:
- 무한 리다이렉트 루프가 발생하지 않음
- `matcher` 설정으로 정확한 경로만 처리됨
- 브라우저 콘솔에 "Too many redirects" 에러가 발생하지 않음
- 최대 1회만 리다이렉트됨

**검증 방법**:
- Middleware 로직 코드 리뷰
- E2E 테스트: 리다이렉트 횟수 카운트
- 수동 테스트: 다양한 경로 조합 시도

**우선순위**: Critical

---

## AC-009: 게임 페이지 사용자 정보 표시

**Given**: 사용자가 로그인된 상태에서 게임 페이지에 접근
**When**: 페이지가 렌더링됨
**Then**:
- 사용자 이메일이 정확히 표시됨
- 이메일이 없는 경우 "게스트"로 표시됨
- 프로필 이미지는 표시되지 않음 (향후 PROFILE-001에서 구현)
- "게임 시작하기" 버튼이 명확히 보임

**검증 방법**:
- 로그인 후 게임 페이지 렌더링 확인
- 단위 테스트: `user?.email || '게스트'` 로직
- E2E 테스트: 화면에 이메일 텍스트 존재 확인

**우선순위**: High

---

## AC-010: 로딩 상태 UX

**Given**: 사용자가 페이지 간 이동 중
**When**: 세션 확인 또는 리다이렉트가 진행 중
**Then**:
- 로딩 스피너가 500ms 이내에 표시됨
- 빈 화면이 1초 이상 노출되지 않음
- Suspense fallback이 적절히 작동함
- 리다이렉트 완료 후 로딩 스피너가 사라짐

**검증 방법**:
- Lighthouse 성능 테스트 (FCP < 1.5s)
- E2E 테스트: 로딩 스피너 존재 확인
- 수동 테스트: 네트워크 스로틀링 적용

**우선순위**: Medium

---

## AC-011: 에러 핸들링

**Given**: Supabase 세션 확인 중 네트워크 오류 발생
**When**: `supabase.auth.getSession()` 호출 실패
**Then**:
- 앱이 크래시되지 않음
- 안전하게 비로그인 상태로 처리됨
- 에러 로그가 콘솔에 기록됨
- 사용자에게 "일시적인 오류 발생" 안내 표시 (선택사항)

**검증 방법**:
- 단위 테스트: `getSession()` 에러 모킹
- 통합 테스트: Supabase 엔드포인트 차단
- E2E 테스트: 네트워크 오프라인 시뮬레이션

**우선순위**: High

---

## AC-012: SEO 및 메타데이터

**Given**: 검색 엔진 크롤러가 메인 페이지 접근
**When**: 페이지 메타데이터 확인
**Then**:
- `<title>` 태그에 "라이어 게임" 포함
- `<meta name="description">` 적절히 설정
- `robots.txt` 허용 확인
- 로그인 CTA가 크롤러에게 노출됨

**검증 방법**:
- Lighthouse SEO 점수 > 90
- `curl` 명령으로 HTML 소스 확인
- Google Search Console 인덱싱 확인

**우선순위**: Low

---

## 완료 조건 (Definition of Done)

모든 인수 기준이 충족되었을 때 SPEC-UI-001은 완료된 것으로 간주합니다.

**필수 조건**:
- [ ] AC-001 ~ AC-005 (Critical) 모두 통과
- [ ] 단위 테스트 커버리지 ≥ 85%
- [ ] E2E 테스트 모두 통과
- [ ] Middleware 무한 루프 없음 (AC-008)
- [ ] 코드 리뷰 승인 완료

**선택 조건**:
- [ ] AC-006 ~ AC-012 (Medium/Low) 통과
- [ ] Lighthouse 성능 점수 ≥ 90
- [ ] 접근성(A11y) 검증 완료

---

## 테스트 시나리오 예시

### 시나리오 1: 신규 사용자 첫 방문 플로우

**단계**:
1. 시크릿 모드로 브라우저 열기
2. 앱 메인 URL 접속
3. "로그인하기" 버튼 클릭
4. OAuth 로그인 완료
5. 자동으로 `/game` 페이지로 이동 확인
6. 사용자 이메일 표시 확인

**예상 결과**: AC-001, AC-002, AC-004 충족

---

### 시나리오 2: 기존 사용자 재방문

**단계**:
1. 이전에 로그인한 브라우저 사용 (세션 유지)
2. 앱 메인 URL 접속
3. 메인 페이지 대신 즉시 `/game` 이동 확인
4. 게임 대기실 화면 표시 확인

**예상 결과**: AC-002, AC-004 충족

---

### 시나리오 3: 비인증 사용자 보호 경로 직접 접근 시도

**단계**:
1. 시크릿 모드로 브라우저 열기
2. 주소창에 `/game` URL 직접 입력
3. 즉시 `/login` 페이지로 리다이렉트 확인
4. 게임 페이지 콘텐츠 렌더링되지 않음 확인

**예상 결과**: AC-003 충족

---

### 시나리오 4: 익명 사용자 플로우

**단계**:
1. 메인 페이지에서 "게스트로 플레이" 버튼 클릭
2. 익명 로그인 완료
3. 게임 페이지로 이동
4. "환영합니다, 게스트님!" 표시 확인

**예상 결과**: AC-006 충족

---

## 회귀 테스트

SPEC-UI-001 완료 후 다음 SPEC 작업 시 반드시 확인해야 할 항목:

- [ ] 게임 페이지 추가 기능이 인증 가드를 우회하지 않는지 확인 (GAME-001)
- [ ] 프로필 페이지가 Middleware 설정을 변경하지 않았는지 확인 (PROFILE-001)
- [ ] 로그아웃 기능이 세션 쿠키를 올바르게 삭제하는지 확인 (AUTH-003)

---

**문서 끝**
